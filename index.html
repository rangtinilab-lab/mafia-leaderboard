<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --card: #121933;
      --muted: #9fb0ff;
      --text: #e8edff;
      --accent: #6ea8ff;
      --good: #19c37d;
      --warn: #ffcc00;
      --bad: #ff6b6b;
      --border: rgba(255,255,255,0.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, #111a3c 0%, #0b1020 55%), var(--bg);
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    header { display: flex; flex-wrap: wrap; align-items: center; gap: 12px 16px; justify-content: space-between; }
    .title { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 44px; height: 44px; border-radius: 12px; display: grid; place-items: center;
      background: linear-gradient(135deg, #6ea8ff, #9a8cff);
      font-weight: 800; color: #0b1020;
      box-shadow: 0 10px 30px rgba(110,168,255,0.35);
    }
    h1 { font-size: clamp(22px, 3.2vw, 32px); margin: 0; letter-spacing: 0.2px; }
    .muted { color: var(--muted); font-size: 13px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 16px; padding: 14px; backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .controls { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 16px 0 8px; }
    .controls .left { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="search"], select, button, .pill {
      background: #0f1630; border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; outline: none; font-size: 14px;
    }
    input[type="search"] { width: min(380px, 100%); }
    button.primary { background: linear-gradient(135deg, #6ea8ff, #9a8cff); color: #0b1020; border: none; font-weight: 700; }
    button.ghost { background: transparent; border: 1px dashed var(--border); color: var(--muted); }

    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; font-weight: 600; color: var(--muted); font-size: 13px; padding: 10px 12px; }
    tbody td { padding: 12px; border-top: 1px solid var(--border); }
    tbody tr { transition: background 120ms ease; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }

    .rank { width: 72px; font-weight: 700; }
    .rank .medal { font-size: 18px; margin-right: 6px; }
    .name { font-weight: 600; }
    .delta {
      font-size: 12px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted);
    }
    .positive { color: var(--good); }
    .negative { color: var(--bad); }

    .footer { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-top: 10px; }
    .footer .small { font-size: 12px; color: var(--muted); }

    .hidden { display: none !important; }
    @media (max-width: 640px) {
      .controls { grid-template-columns: 1fr; }
      .rank { width: 56px; }
      thead .optional, tbody .optional { display: none; }
    }
  </style>
</head>
<body>
  <!--
    LIVE LEADERBOARD â€” Google Sheets (pure frontend)

    HOW TO USE (no backend needed):
    1) Option A â€” Normal Sheet ID (recommended)
       â€¢ Open your Google Sheet (the regular URL that has /spreadsheets/d/<ID>/edit)
       â€¢ File â†’ Share â†’ Publish to web â†’ pick the tab â†’ Publish
       â€¢ Use this page with: ?sheetId=<ID>&sheet=<TabName>&name=<NameCol>&score=<PointsCol>&team=<TeamCol>&refresh=60

    2) Option B â€” Publish-to-web ID (starts with 2PACX-)
       â€¢ File â†’ Share â†’ Publish to web â†’ Copy the CSV link (it contains /d/e/2PACX-.../pub?gid=...&output=csv)
       â€¢ Extract the 2PACX... part as pubId and the gid number for your tab
       â€¢ Use this page with: ?pubId=<2PACX...>&gid=<gid>&name=<NameCol>&score=<PointsCol>&team=<TeamCol>&refresh=60

    NOTES:
    â€¢ This page fetches CSV via the Google Visualization "gviz" endpoint and parses with PapaParse.
    â€¢ If your sheet is private, either publish as above, or use a tiny backend proxy / Sheets API with OAuth.
  -->

  <div class="container">
    <header>
      <div class="title">
        <div class="logo">LB</div>
        <div>
          <h1 id="pageTitle">Leaderboard</h1>
          <div class="muted" id="subtitle">Live from Google Sheets</div>
        </div>
      </div>
      <div class="muted" id="lastUpdated">â€”</div>
    </header>

    <div class="card">
      <div class="tableWrap">
        <table id="table">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div class="small">Tip: update the sheet and this page will autoâ€‘refresh.</div>
        <div class="small" id="sourceLabel"></div>
      </div>
    </div>
  </div>

  <script>
// Minimal, dependency-free leaderboard (Rank â€¢ Name â€¢ Score)
(function(){
  const params = new URLSearchParams(location.search);
  const CONFIG = {
    sheetId: params.get('sheetId') || '',
    pubId: params.get('pubId') || '',   // 2PACX-...
    gid: params.get('gid') || '0',
    sheetName: params.get('sheet') || 'Sheet1',
    nameKey: params.get('name') || 'Name',
    scoreKey: params.get('score') || 'Points',
    descending: (params.get('order') || 'desc').toLowerCase() !== 'asc',
    refreshSeconds: +params.get('refresh') || 60,
    pageTitle: params.get('title') || 'Leaderboard',
  };

  const els = {
    lastUpdated: document.getElementById('lastUpdated'),
    sourceLabel: document.getElementById('sourceLabel'),
    theadRow: document.getElementById('theadRow'),
    tbody: document.getElementById('tbody'),
    pageTitle: document.getElementById('pageTitle'),
    subtitle: document.getElementById('subtitle'),
  };
  els.pageTitle.textContent = CONFIG.pageTitle;
  els.subtitle.textContent = CONFIG.pubId ? `Live from Google Sheets â€¢ gid ${CONFIG.gid}` : `Live from Google Sheets â€¢ ${CONFIG.sheetName}`;

  function csvUrl(sheetId, sheetName){
    if (CONFIG.pubId){
      const base = `https://docs.google.com/spreadsheets/d/e/${CONFIG.pubId}/pub`;
      const q = new URLSearchParams({ gid: CONFIG.gid, single: 'true', output: 'csv', cachebust: Date.now() });
      return `${base}?${q}`;
    }
    const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq`;
    const q = new URLSearchParams({ tqx: 'out:csv', sheet: sheetName, cachebust: Date.now() });
    return `${base}?${q}`;
  }

  // Tiny CSV parser that handles quotes and commas
  function parseCSV(csv){
    const lines = csv.replace(/
/g, '
').replace(/
/g, '
').split('
').filter(l => l.length > 0);
    const parseLine = (line)=>{
      const out = []; let cur = ''; let inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){
          if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else { inQ = !inQ; }
        } else if (ch === ',' && !inQ){ out.push(cur); cur = ''; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    };
    const headers = parseLine(lines[0]).map(h => h.replace(/ï»¿/g,'').trim());
    const rows = lines.slice(1).map(l => {
      const cells = parseLine(l);
      const obj = {}; headers.forEach((h, i) => obj[h] = cells[i]);
      return obj;
    });
    return { headers, rows };
  }

  async function fetchRows(){
    const url = csvUrl(CONFIG.sheetId, CONFIG.sheetName);
    els.sourceLabel.textContent = CONFIG.pubId ? `Source: gid ${CONFIG.gid}` : `Source: ${CONFIG.sheetName}`;
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Fetch failed (${res.status})`);
    const csv = await res.text();
    const { headers, rows } = parseCSV(csv);
    // normalize keys
    const normalized = rows.map(r => {
      const o = {}; Object.keys(r).forEach(k => { if (k) o[String(k).trim()] = r[k]; });
      return o;
    });
    return { headers, rows: normalized };
  }

  function detectColumns(headers){
    let nameKey = headers.includes(CONFIG.nameKey) ? CONFIG.nameKey : (headers.find(h => h.toLowerCase().includes('name')) || headers[0]);
    let scoreKey = headers.includes(CONFIG.scoreKey) ? CONFIG.scoreKey : (headers.find(h => /point|score|total/i.test(h)) || headers[1] || headers[0]);
    return { nameKey, scoreKey };
  }

  function rankRows(rows, scoreKey){
    for (const r of rows){
      const v = r[scoreKey];
      if (typeof v === 'string') r[scoreKey] = Number(v.replace(/,/g,'').trim() || 0);
    }
    rows.sort((a,b)=>{
      const av = Number(a[scoreKey] ?? 0), bv = Number(b[scoreKey] ?? 0);
      return CONFIG.descending ? (bv - av) : (av - bv);
    });
    let lastScore = null, lastRank = 0, i = 0;
    for (const r of rows){
      i++; const s = Number(r[scoreKey] ?? 0);
      if (s === lastScore){ r.__rank = lastRank; }
      else { r.__rank = i; lastRank = i; lastScore = s; }
    }
    return rows;
  }

  function medalFor(rank){ return rank===1?'ðŸ¥‡':rank===2?'ðŸ¥ˆ':rank===3?'ðŸ¥‰':''; }

  function renderTable(rows, cols){
    const { nameKey, scoreKey } = cols;
    els.theadRow.innerHTML = '';
    const thRank = document.createElement('th'); thRank.textContent = 'Rank'; thRank.className = 'rank'; els.theadRow.appendChild(thRank);
    const thName = document.createElement('th'); thName.textContent = nameKey; thName.className = 'name'; els.theadRow.appendChild(thName);
    const thScore = document.createElement('th'); thScore.textContent = scoreKey; els.theadRow.appendChild(thScore);

    els.tbody.innerHTML = '';
    for (const r of rows){
      const tr = document.createElement('tr');
      const tdRank = document.createElement('td'); tdRank.className = 'rank'; tdRank.innerHTML = `<span class="medal">${medalFor(r.__rank)}</span><span>#${r.__rank}</span>`; tr.appendChild(tdRank);
      const tdName = document.createElement('td'); tdName.className = 'name'; tdName.textContent = r[nameKey] ?? ''; tr.appendChild(tdName);
      const tdScore = document.createElement('td'); tdScore.textContent = r[scoreKey] ?? 0; tr.appendChild(tdScore);
      els.tbody.appendChild(tr);
    }
  }

  async function refresh(){
    try {
      const { headers, rows } = await fetchRows();
      const cols = detectColumns(headers);
      const ranked = rankRows([...rows], cols.scoreKey);
      renderTable(ranked, cols);
      els.lastUpdated.textContent = `${new Date().toLocaleString()} â€¢ ${ranked.length} rows`;
    } catch (err){
      console.error(err);
      els.lastUpdated.textContent = `Error: ${err.message}`;
    }
  }

  refresh();
  if (CONFIG.refreshSeconds > 0) setInterval(refresh, CONFIG.refreshSeconds * 1000);
})();
</script>
</body>
</html>
