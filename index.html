<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --card: #121933;
      --muted: #9fb0ff;
      --text: #e8edff;
      --accent: #6ea8ff;
      --good: #19c37d;
      --warn: #ffcc00;
      --bad: #ff6b6b;
      --border: rgba(255,255,255,0.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, #111a3c 0%, #0b1020 55%), var(--bg);
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    header { display: flex; flex-wrap: wrap; align-items: center; gap: 12px 16px; justify-content: space-between; }
    .title { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 44px; height: 44px; border-radius: 12px; display: grid; place-items: center;
      background: linear-gradient(135deg, #6ea8ff, #9a8cff);
      font-weight: 800; color: #0b1020;
      box-shadow: 0 10px 30px rgba(110,168,255,0.35);
    }
    h1 { font-size: clamp(22px, 3.2vw, 32px); margin: 0; letter-spacing: 0.2px; }
    .muted { color: var(--muted); font-size: 13px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 16px; padding: 14px; backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .controls { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 16px 0 8px; }
    .controls .left { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="search"], select, button, .pill {
      background: #0f1630; border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; outline: none; font-size: 14px;
    }
    input[type="search"] { width: min(380px, 100%); }
    button.primary { background: linear-gradient(135deg, #6ea8ff, #9a8cff); color: #0b1020; border: none; font-weight: 700; }
    button.ghost { background: transparent; border: 1px dashed var(--border); color: var(--muted); }

    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; font-weight: 600; color: var(--muted); font-size: 13px; padding: 10px 12px; }
    tbody td { padding: 12px; border-top: 1px solid var(--border); }
    tbody tr { transition: background 120ms ease; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }

    .rank { width: 72px; font-weight: 700; }
    .rank .medal { font-size: 18px; margin-right: 6px; }
    .name { font-weight: 600; }
    .delta {
      font-size: 12px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted);
    }
    .positive { color: var(--good); }
    .negative { color: var(--bad); }

    .footer { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-top: 10px; }
    .footer .small { font-size: 12px; color: var(--muted); }

    .hidden { display: none !important; }
    @media (max-width: 640px) {
      .controls { grid-template-columns: 1fr; }
      .rank { width: 56px; }
      thead .optional, tbody .optional { display: none; }
    }
  </style>
</head>
<body>
  <!--
    LIVE LEADERBOARD â€” Google Sheets (pure frontend)

    HOW TO USE (no backend needed):
    1) Option A â€” Normal Sheet ID (recommended)
       â€¢ Open your Google Sheet (the regular URL that has /spreadsheets/d/<ID>/edit)
       â€¢ File â†’ Share â†’ Publish to web â†’ pick the tab â†’ Publish
       â€¢ Use this page with: ?sheetId=<ID>&sheet=<TabName>&name=<NameCol>&score=<PointsCol>&team=<TeamCol>&refresh=60

    2) Option B â€” Publish-to-web ID (starts with 2PACX-)
       â€¢ File â†’ Share â†’ Publish to web â†’ Copy the CSV link (it contains /d/e/2PACX-.../pub?gid=...&output=csv)
       â€¢ Extract the 2PACX... part as pubId and the gid number for your tab
       â€¢ Use this page with: ?pubId=<2PACX...>&gid=<gid>&name=<NameCol>&score=<PointsCol>&team=<TeamCol>&refresh=60

    NOTES:
    â€¢ This page fetches CSV via the Google Visualization "gviz" endpoint and parses with PapaParse.
    â€¢ If your sheet is private, either publish as above, or use a tiny backend proxy / Sheets API with OAuth.
  -->

  <div class="container">
    <header>
      <div class="title">
        <div class="logo">LB</div>
        <div>
          <h1 id="pageTitle">Leaderboard</h1>
          <div class="muted" id="subtitle">Live from Google Sheets</div>
        </div>
      </div>
      <div class="muted" id="lastUpdated">â€”</div>
    </header>

    <div class="card">
      <div class="controls">
        <div class="left">
          <input id="search" type="search" placeholder="Search name or teamâ€¦" />
          <select id="sortBy"></select>
          <button id="refreshBtn" class="ghost" title="Refresh now">â†» Refresh</button>
        </div>
        <div class="right">
          <span class="pill" id="rowsCount">0 rows</span>
        </div>
      </div>

      <div class="tableWrap">
        <table id="table">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div class="small">Tip: update the sheet and this page will autoâ€‘refresh.</div>
        <div class="small" id="sourceLabel"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const CONFIG = {
      sheetId: params.get('sheetId') || 'YOUR_SHEET_ID_HERE',
      pubId: params.get('pubId') || '', // Support for Publish-to-web ID (starts with 2PACX-)
      gid: params.get('gid') || '0',    // Sheet/tab GID when using pubId
      sheetName: params.get('sheet') || 'Sheet1',
      nameKey: params.get('name') || 'Name',
      scoreKey: params.get('score') || 'Points',
      teamKey: params.get('team') || '', // optional
      extraColumns: (params.get('extra') || '').split(',').filter(Boolean), // comma-separated headers to also show
      descending: (params.get('order') || 'desc').toLowerCase() !== 'asc',
      refreshSeconds: +params.get('refresh') || 60,
      pageTitle: params.get('title') || 'Leaderboard',
    };

    const els = {
      lastUpdated: document.getElementById('lastUpdated'),
      sourceLabel: document.getElementById('sourceLabel'),
      rowsCount: document.getElementById('rowsCount'),
      search: document.getElementById('search'),
      sortBy: document.getElementById('sortBy'),
      table: document.getElementById('table'),
      theadRow: document.getElementById('theadRow'),
      tbody: document.getElementById('tbody'),
      pageTitle: document.getElementById('pageTitle'),
      subtitle: document.getElementById('subtitle'),
      refreshBtn: document.getElementById('refreshBtn'),
    };

    els.pageTitle.textContent = CONFIG.pageTitle;
    els.subtitle.textContent = `Live from Google Sheets â€¢ ${CONFIG.sheetName}`;

    function csvUrl(sheetId, sheetName) {
      // If a Publish-to-web ID is supplied (starts with 2PACX-), use the CSV publish endpoint.
      if (CONFIG.pubId) {
        const base = `https://docs.google.com/spreadsheets/d/e/${CONFIG.pubId}/pub`;
        const query = new URLSearchParams({ gid: CONFIG.gid, single: 'true', output: 'csv', cachebust: Date.now() });
        return `${base}?${query}`;
      }
      // Otherwise, use the gviz CSV endpoint on the normal spreadsheetId
      const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq`;
      const query = new URLSearchParams({ tqx: 'out:csv', sheet: sheetName, cachebust: Date.now() });
      return `${base}?${query}`;
    }

    async function fetchRows() {
      const url = csvUrl(CONFIG.sheetId, CONFIG.sheetName);
      els.sourceLabel.textContent = `Source: ${CONFIG.sheetName}`;

      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Fetch failed (${res.status})`);
      const csv = await res.text();
      const parsed = Papa.parse(csv, { header: true, dynamicTyping: true, skipEmptyLines: true });
      if (parsed.errors?.length) console.warn('CSV parse warnings:', parsed.errors.slice(0,3));
      // Normalize keys by trimming & removing BOMs/spaces
      const rows = parsed.data.map(row => {
        const clean = {};
        for (const [k, v] of Object.entries(row)) {
          if (!k) continue;
          const nk = String(k).replace(/\uFEFF/g, '').trim();
          clean[nk] = v;
        }
        return clean;
      });
      return rows;
    }

    function detectColumns(rows) {
      if (!rows.length) return null;
      const headers = Object.keys(rows[0]);
      // Fallbacks if configured keys are missing
      let nameKey = headers.find(h => h.toLowerCase().includes('name')) || headers[0];
      let scoreKey = headers.find(h => /point|score|total|value/i.test(h)) || headers[1] || headers[0];
      // Respect explicit config when present in headers
      if (headers.includes(CONFIG.nameKey)) nameKey = CONFIG.nameKey;
      if (headers.includes(CONFIG.scoreKey)) scoreKey = CONFIG.scoreKey;
      const teamKey = headers.includes(CONFIG.teamKey) ? CONFIG.teamKey : headers.find(h => /team|group|unit/i.test(h));
      const extra = CONFIG.extraColumns.filter(c => headers.includes(c));
      return { headers, nameKey, scoreKey, teamKey, extra };
    }

    function rankRows(rows, scoreKey) {
      // Coerce score to number where possible
      for (const r of rows) {
        const val = r[scoreKey];
        if (typeof val === 'string') r[scoreKey] = Number(val.replace(/,/g, ''));
      }
      rows.sort((a,b) => {
        const av = Number(a[scoreKey] ?? 0);
        const bv = Number(b[scoreKey] ?? 0);
        return CONFIG.descending ? (bv - av) : (av - bv);
      });
      let lastScore = null, lastRank = 0, i = 0;
      for (const r of rows) {
        i++;
        const score = Number(r[scoreKey] ?? 0);
        if (score === lastScore) {
          r.__rank = lastRank; // tie
        } else {
          r.__rank = i;
          lastRank = i; lastScore = score;
        }
      }
      return rows;
    }

    function buildSortOptions(headers, preferred) {
      els.sortBy.innerHTML = '';
      const opts = [preferred].concat(headers.filter(h => h !== preferred));
      for (const h of opts) {
        const o = document.createElement('option');
        o.value = h; o.textContent = `Sort by ${h}`; els.sortBy.appendChild(o);
      }
      els.sortBy.value = preferred;
    }

    function medalFor(rank) {
      if (rank === 1) return 'ðŸ¥‡';
      if (rank === 2) return 'ðŸ¥ˆ';
      if (rank === 3) return 'ðŸ¥‰';
      return '';
    }

    function renderTable(rows, columns) {
      const { nameKey, scoreKey, teamKey, extra } = columns;
      // Build header
      els.theadRow.innerHTML = '';
      const thRank = document.createElement('th'); thRank.textContent = 'Rank'; thRank.className = 'rank';
      els.theadRow.appendChild(thRank);
      const thName = document.createElement('th'); thName.textContent = nameKey; thName.className = 'name';
      els.theadRow.appendChild(thName);
      if (teamKey) { const thTeam = document.createElement('th'); thTeam.textContent = teamKey; thTeam.className = 'optional'; els.theadRow.appendChild(thTeam); }
      for (const col of extra) { const th = document.createElement('th'); th.textContent = col; th.className = 'optional'; els.theadRow.appendChild(th); }
      const thScore = document.createElement('th'); thScore.textContent = scoreKey; els.theadRow.appendChild(thScore);

      // Body
      els.tbody.innerHTML = '';
      const q = (els.search.value || '').toLowerCase().trim();
      const filtered = rows.filter(r => {
        if (!q) return true;
        const hay = [r[nameKey], r[teamKey], ...extra.map(k => r[k])].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
      });

      for (const r of filtered) {
        const tr = document.createElement('tr');
        const tdRank = document.createElement('td'); tdRank.className = 'rank';
        tdRank.innerHTML = `<span class="medal">${medalFor(r.__rank)}</span><span>#${r.__rank}</span>`;
        tr.appendChild(tdRank);

        const tdName = document.createElement('td'); tdName.className = 'name'; tdName.textContent = r[nameKey] ?? '';
        tr.appendChild(tdName);

        if (teamKey) { const tdTeam = document.createElement('td'); tdTeam.className = 'optional'; tdTeam.textContent = r[teamKey] ?? ''; tr.appendChild(tdTeam); }
        for (const col of extra) { const td = document.createElement('td'); td.className = 'optional'; td.textContent = r[col] ?? ''; tr.appendChild(td); }

        const tdScore = document.createElement('td'); tdScore.textContent = r[scoreKey] ?? 0; tr.appendChild(tdScore);
        els.tbody.appendChild(tr);
      }

      els.rowsCount.textContent = `${filtered.length} row${filtered.length === 1 ? '' : 's'}`;
    }

    let state = { rows: [], columns: null };

    async function refresh() {
      try {
        document.body.style.cursor = 'progress';
        const rows = await fetchRows();
        const columns = detectColumns(rows);
        if (!columns) throw new Error('No rows found');

        // If user changed sort column via UI, persist it, else default to scoreKey
        if (!state.columns) { buildSortOptions(columns.headers, columns.scoreKey); }
        const sortKey = els.sortBy.value || columns.scoreKey;

        const ranked = rankRows([...rows], sortKey);
        state = { rows: ranked, columns: { ...columns, scoreKey: sortKey } };
        renderTable(ranked, state.columns);

        els.lastUpdated.textContent = new Date().toLocaleString();
      } catch (err) {
        console.error(err);
        els.lastUpdated.textContent = `Error: ${err.message}`;
      } finally {
        document.body.style.cursor = 'default';
      }
    }

    // Events
    els.search.addEventListener('input', () => state.rows.length && renderTable(state.rows, state.columns));
    els.sortBy.addEventListener('change', () => {
      if (!state.rows.length) return;
      state.rows = rankRows(state.rows, els.sortBy.value);
      state.columns.scoreKey = els.sortBy.value;
      renderTable(state.rows, state.columns);
    });
    document.getElementById('refreshBtn').addEventListener('click', refresh);

    // Auto refresh
    refresh();
    if (CONFIG.refreshSeconds > 0) {
      setInterval(refresh, CONFIG.refreshSeconds * 1000);
    }
  </script>
</body>
</html>
